<!--
 Licensed to the Apache Software Foundation (ASF) under one or more
 contributor license agreements.  See the NOTICE file distributed with
 this work for additional information regarding copyright ownership.
 The ASF licenses this file to You under the Apache License, Version 2.0
 (the "License"); you may not use this file except in compliance with
 the License.  You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<project name="release" basedir="..">

  <description>
    This an Ant build file to automate the release process of
    Apache Slider (incubating).

    It wraps the core maven build and package commands with the
    operations needed to actually publish the artifacts, generate
    email announcements, etc.

    Requirements
    -all the various build tools are installed and on the path
    -you have git installed

    properties to set in build.xml or on the CLI

    slider.release.version=0.91.0
    slider.develop.version=0.92-SNAPSHOT
    release.jira=SLIDER-1014

    #optional
    mvn.extra.args
    slider.conf.dir: value of SLIDER_CONF_DIR for integration tests
    upload.user: username for asf uploads. Default: current username
    upload.disabled: set property to disable uploads to asf infra
  </description>

  <target name="init">
    <property file="build.properties"/>
    <!-- Create the time stamp -->
    <tstamp/>

    <macrodef name="require">
      <attribute name="property" />
      <attribute name="text" default="" />
      <sequential>
        <fail unless="@{property}">
          @{text}
          Unset property: @{property}
        </fail>
      </sequential>
    </macrodef>

    <macrodef name="must-be-zero">
      <attribute name="value" />
      <attribute name="text" default="" />
      <sequential>
        <fail>
          <condition>
            <not>
              <equals arg1="0" arg2="@{value}" />
            </not>
          </condition>
          @{text}
          "@{value}" != 0
        </fail>
      </sequential>
    </macrodef>

    <macrodef name="must-exist">
      <attribute name="file" />
      <attribute name="text" default=""/>
      <sequential>
        <fail>
          <condition>
            <not><available file="@{file}"/></not>
          </condition>
          @{text}
          File not found: @{file}
        </fail>
      </sequential>
    </macrodef>

    <require property="slider.release.version" />
    <require property="slider.develop.version" />
    <require property="release.jira" />
    <property name="release.rc.suffix" value =""/>

    <property name="mvn.skiptests" value="-DskipTests" />
    <property name="mvn.profile" value=" -Papache-release" />
    <property name="mvn.extra.args" value="" />

    <!-- template exec with the failonerror flag set-->
    <presetdef name="ex">
      <exec failonerror="true">
      </exec>
    </presetdef>

    <!-- maven command. the value of ${mvn.extra.args} is appended-->
    <macrodef name="mvn">
      <attribute name="command"/>
      <attribute name="tests" default="${mvn.skiptests}" />
      <attribute name="profile" default="${mvn.profile}" />
      <sequential>
        <echo>maven : @{command}</echo>
        <ex executable="mvn" >
          <arg line="@{command} @{tests} @{profile} ${mvn.extra.args}"/>
        </ex>
      </sequential>
    </macrodef>

    <!--
    run maven and don't fail even if it does. Instead the property "property"
    is set to the return code
    -->
    <macrodef name="mvn-nofail">
      <attribute name="command" />
      <attribute name="property"/>
      <attribute name="tests" default="${mvn.skiptests}"/>
      <attribute name="profile" default="${mvn.profile}"/>
      <sequential>
        <echo>maven : @{command}</echo>
        <exec executable="mvn" failonerror="false" resultproperty="@{property}">
          <arg line="@{command} @{tests} @{profile} ${mvn.extra.args}" />
        </exec>
      </sequential>
    </macrodef>

    <!-- set the poms to a new version -->
    <macrodef name="mvn-setversion">
      <attribute name="version" />
      <sequential>
        <mvn command="versions:set -DnewVersion=@{version}" />
        <delete dir="." includes="**/pom.xml.versionsBackup" />
      </sequential>
    </macrodef>


    <!-- Run a git command-->
    <macrodef name="git">
      <attribute name="command"/>
      <sequential>
        <echo>git @{command}</echo>
        <ex executable="git" >
          <arg line="@{command}"/>
        </ex>
      </sequential>
    </macrodef>

    <macrodef name="gpg2">
      <attribute name="command"/>
      <sequential>
        <echo>gpg2 @{command}</echo>
        <ex executable="gpg2" >
          <arg line="@{command}"/>
        </ex>
      </sequential>
    </macrodef>


    <property name="release.name" value="slider-${slider.release.version}" />
    <property name="upload.user" value="${user.name}" />
    <property name="upload.keyfile" location="${user.home}/.ssh/id_dsa" />
    <property name="expanded.tar" location="slider-assembly/target/${release.name}-all/" />
    <property name="source.archive.name" value="apache-${release.name}-source-release" />
    <property name="slider.source.tar.gz"
      location="target/${source.archive.name}.tar.gz" />
    <property name="slider.source.zip"
      location="target/${source.archive.name}.zip" />
    <property name="application.dir" location="${expanded.tar}/${release.name}/" />

    <property name="upload.host" value="home.apache.org" />
    <property name="upload.basedir" value="public_html" />
    <property name="upload.trust" value="false" />
    <property name="upload.dir" value="${release.name}${release.rc.suffix}" />
    <property name="upload.dest" value="${upload.basedir}/${upload.dir}" />
    <property name="t_upload_base" location="target/${upload.basedir}" />
    <property name="t_upload_dest" location="${t_upload_base}/${upload.dir}" />
    <echo>
      Releasing Apache Slider (incubating)
      ====================================

      slider.release.version:   ${slider.release.version}
      slider.develop.version:   ${slider.develop.version}
      release.jira:             ${release.jira}
      slider.conf.dir:          ${slider.conf.dir}
      upload.user:              ${upload.user}
    </echo>


  </target>

  <target name="clean" depends="init">
    <mvn command="clean -Pall-modules" />
  </target>

  <target name="install" depends="init, rat">
    <mvn command="install" />
  </target>

  <target name="test" depends="init">
    <mvn command="test" />
  </target>

  <target name="integration-test" depends="init">
    <require property="slider.conf.dir" />
    <must-exist file="${slider.conf.dir}" />
    <mvn command="integration-test -Dslider.conf.dir=${slider.conf.dir} " />
  </target>

  <target name="rat" depends="init, clean"
    description="Execute the RAT scan, print the results and fail if there is a problem">
    <mvn-nofail command="apache-rat:check -Prat" property="rat.result"/>
    <loadfile property="rat.txt" srcfile="target/rat.txt" />
    <echo> return code =${rat.result}</echo>
    <must-be-zero value="${rat.result}" text="${rat.txt}"/>
  </target>

  <target name="package" depends="init">
    <mvn command="site:site package"/>
  </target>

  <target name="stage" depends="init">
    <mvn command="site:stage"/>
  </target>

  <target name="set-to-release-version" depends="init"
    description="Set the POM version to slider.release.version ">
    <mvn-setversion version="${slider.release.version}" />
  </target>

  <target name="set-to-develop-version" depends="init"
    description="Set the POM version to slider.develop.version ">
    <mvn-setversion version="${slider.develop.version}" />
  </target>

  <target name="validate-packaging" depends="init">
    <must-exist file="${expanded.tar}"/>
    <must-exist file="${application.dir}"/>
    <must-exist file="${application.dir}/lib/slider-agent.tar.gz"/>
    <must-exist file="${slider.source.tar.gz}"/>
    <must-exist file="${slider.source.zip}"/>
  </target>

  <target name="checksums" depends="validate-packaging">
    <checksum algorithm="md5" forceoverwrite="true" >
      <fileset file="${slider.source.tar.gz}" />
      <fileset file="${slider.source.zip}" />
    </checksum>
    <checksum algorithm="sha1" forceoverwrite="true">
      <fileset file="${slider.source.tar.gz}" />
      <fileset file="${slider.source.zip}" />
    </checksum>
  </target>

  <target name="tarball" depends="clean, rat, package, validate-packaging, checksums" />

  <target name="clean-target-dir" depends="init">
    <delete>
      <fileset dir="target"
        includes="rat.txt,.plxarc,archive-tmp,maven-shared-archive-resources"/>
    </delete>
  </target>

  <target name="copy-tasklibs" depends="init"
    description="copy int to the ant lib any needed jars -from the maven repo">
    <property name="jsch.version" value="0.1.51" />
    <property name="antlib.dir" location="${user.home}/.ant/lib" />
    <property name="mvnrepo.dir" location="${user.home}/.m2/repository" />
    <copy
      file="${mvnrepo.dir}/com/jcraft/jsch/${jsch.version}/jsch-${jsch.version}.jar"
      todir="${antlib.dir}"
      />
  </target>

  <target name="prepare-upload-rc" depends="validate-packaging" >

    <delete dir="${t_upload_base}" />
    <mkdir dir="${t_upload_dest}/" />
    <copy todir="${t_upload_dest}" >
      <fileset dir="target" includes="${source.archive.name}.*/" />
    </copy>
    <ex command="ls"><arg line="-al ${t_upload_dest}"/></ex>
  </target>

  <target name="upload" depends="init" unless="upload.disabled">
    <must-exist file="${upload.keyfile}" />
    <scp remoteTodir="${upload.user}@${upload.host}:${upload.basedir}"
      keyfile="${upload.keyfile}"
      sftp="true"
      trust="${upload.trust}"
      verbose="true">
      <fileset dir="${t_upload_base}" includes="**/*" />

    </scp>

  </target>


</project>
